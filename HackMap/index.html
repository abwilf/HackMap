<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border: 1px solid #d3d3d3;
    background-color: #f1f1f1;
}
</style>
<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
</head>
<body>
<script>

//Init function (e.g. main)
function start() {
  treeCanvas.start()
}

//Constructor for Nodes
function Node(x, y, data){
    this.x = x;
    this.y = y;


    this.data = data;


    this.depth = null;
    this.parent = null;

    this.children = [];
}

function saveToJSON(node_in) {
	var obj = JSONHelper(root, "");
	console.log(obj);
	// write to JSON
}
// call with root
function JSONHelper(node_in, string) {
	// loop through root and children, call this on each
	if (!(typeof node_in.children != "undefined" && node_in.children != null && node_in.children.length > 0)) {
		return string;
	}
	// write string to JSON
	for (i = 0; i < this.children.length; ++i) {
		string += JSON.stringify(node_in);
		string += JSONHelper(this.children[i], string);	// recursive call
	}
	return string;
}

//Helper function, iterates through tree and calls d on each node
function traverseAndDo(node, d){
    d(node);
    traverseAndDo = function(node){
      d(node);
      node.children.forEach(traverseAndDo);
    }
    node.children.forEach(traverseAndDo);
}

//Given a node pointer, attach a node to it
function add(parent, child){
    child.parent = parent;
    parent.children.push(child);
    child = parent.depth + 1;
}

//TODO
function remove(node){

      for (var i = 0; i < node.parent.children.length; i++) {
          if (node.parent.children[i] === node) {
              node.parent.children.splice(i, 1);
            return;
          }
      }
      // TODO: update
}

function drawNode(node){

  context = treeCanvas.getContext()
  context.fillText(node.data, node.x, node.y)

    for (var i = 0; i < node.children.length; ++i) {
		context.beginPath();
		context.moveTo(node.x-10,node.y-5);
		context.lineTo(node.children[i].x-10,node.children[i].y-5);
		context.stroke();
	}	
	context.beginPath();
	context.arc(node.x - 10,node.y - 5,5,0,2*Math.PI);
	context.stroke();

}


//Hide/Show the subtree of the selected node
function toggleSubtree(node){
  if(this.children){
    this._children = this.children;
    this.children = null;
  }
  else{
    this.children = this._children;
    this._children = null;
  }
}
/*
// string info of second ellipse
function draw_node(x1, y1, rx1, ry1, type, x2, y2, rx2, ry2) {

    <defs>
       <marker id="arrow" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto" markerUnits="strokeWidth">
           <path d="M0,0 L0,6 L9,3 z" fill="#f00" />
       </marker>
    </defs>

 // calculate B0

  if (type == "def") {
    // draw line
    <path d="Mx1 (y1+ry1) L x2 (y2-ry2)" fill="transparent" stroke="black"/>
  }

  else {
    // draw arrow
    <line x1="x1" y1="y1+ry1" x2="x2" y2="y2+ry2" stroke="#000" stroke-width="5" marker-end="url(#arrow)" />
  }
}
*/

//Creates a canvas for drawing
var treeCanvas = {
    canvas : document.createElement("canvas"),

    start : function() {

        this.canvas.width = $(document).width();
        this.canvas.height = $(document).height();

        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.context.font = "15px Arial";


    },

    getContext : function() {
        return this.context
    }
}

//set up tree with empty root node
var root = new Node($(document).width() / 2, 50, "I'm Root.");
root.depth = 0;

//draw_node(50, 50, 20, 20, "butt", 500, 500, 20, 20)

treeCanvas.start();
drawNode(root);
add(root, new Node(root.x - 50, 100, "I'm a kid."));

add(root, new Node(root.x + 50, 100, "I'm a kid 2."));

add(root, new Node(root.x, 150, "I'm a Grandkid."));

traverseAndDo(root, drawNode);

</script>

</body>
</html>
